<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Integral de Reportes OXXO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .bg-oxxo-red { background-color: #E61C2D; }
        .text-oxxo-red { color: #E61C2D; }
        
        .btn-primary { background-color: #E61C2D; transition: all 0.2s ease; }
        .btn-primary:hover:not(:disabled) {
            background-color: #c41220;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(230, 28, 45, 0.3);
        }
        .btn-primary:disabled { opacity: 0.7; cursor: not-allowed; }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }

        @keyframes bounce-in {
            0% { transform: scale(0.5); opacity: 0; }
            80% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); }
        }
        .success-message { animation: bounce-in 0.3s ease-out; }

        /* Estilo para el select cuando está deshabilitado */
        select:disabled {
            background-color: #f9fafb;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-white border-b border-gray-200 shadow-sm sticky top-0 z-50">
        <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-20">
                <div class="flex items-center">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/6/66/Oxxo_Logo.svg" alt="OXXO Logo" class="h-10 w-auto mr-4">
                    <div class="hidden md:block border-l border-gray-300 h-8 mx-4"></div>
                    <div class="flex flex-col justify-center">
                        <span class="text-lg font-bold text-gray-800 tracking-tight">Sistemas y Enlaces</span>
                        <span class="text-xs text-green-600 font-bold uppercase tracking-wide flex items-center gap-1">
                            <span class="w-2 h-2 rounded-full bg-green-500"></span> Conectado al Servidor (Python)
                        </span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="last-status" class="flex items-center gap-2 text-sm font-semibold text-gray-500">
                        <i data-lucide="minus-circle" class="w-5 h-5 text-gray-400"></i>
                        <span class="hidden sm:inline">Sin Envíos</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Contenido Principal -->
    <main class="flex-grow container mx-auto px-4 py-8 max-w-4xl">
        <div class="bg-white rounded-xl shadow-2xl border-t-4 border-oxxo-red overflow-hidden">
            <!-- Cabecera -->
            <div class="bg-white px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                <h2 class="text-xl font-extrabold text-gray-800 flex items-center gap-2">
                    <i data-lucide="file-plus" class="w-6 h-6 text-oxxo-red"></i>
                    Generador de Reporte
                </h2>
            </div>

            <!-- Cuerpo del formulario -->
            <div class="p-6 md:p-8 space-y-6">
                
                <!-- Fila 1: Tienda y Proveedor -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="tienda" class="block text-sm font-semibold text-gray-700 mb-1">CR / Plaza / Tienda</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i data-lucide="store" class="h-5 w-5 text-gray-400"></i>
                            </div>
                            <input type="text" id="tienda" class="block w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-200 focus:border-oxxo-red" placeholder="Ej: 10MON - Monclova Centro">
                        </div>
                    </div>
                    <div>
                        <label for="proveedor_email" class="block text-sm font-semibold text-gray-700 mb-1">Correo de Contacto Proveedor</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i data-lucide="mail" class="h-5 w-5 text-gray-400"></i>
                            </div>
                            <input type="email" id="proveedor_email" value="soporte.ti@ejemplo.com" class="block w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-200 focus:border-oxxo-red">
                        </div>
                    </div>
                </div>

                <!-- Fila 2: Categoría y Prioridad (NUEVO) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="categoria" class="block text-sm font-semibold text-gray-700 mb-1">Categoría del Reporte</label>
                        <select id="categoria" onchange="actualizarPlantilla()" class="block w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-200 focus:border-oxxo-red">
                            <option value="">-- Seleccione una opción --</option>
                            <option value="Fallo de Equipo">Fallo de Equipo (PDV, Handheld)</option>
                            <option value="Mantenimiento">Mantenimiento (Refrigeradores, AC)</option>
                            <option value="Fallo de Enlaces">Fallo de Enlaces (Red, Internet)</option>
                            <option value="Daño a Tienda">Daño a Tienda (Vidrios, Puertas)</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    <div>
                        <label for="prioridad" class="block text-sm font-semibold text-gray-700 mb-1">Prioridad del Reporte</label>
                        <select id="prioridad" class="block w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-200 focus:border-oxxo-red">
                            <option value="Baja">Baja</option>
                            <option value="Normal" selected>Normal</option>
                            <option value="Urgente">Urgente</option>
                        </select>
                    </div>
                </div>

                <!-- Fila 3: Plantilla (Textarea) -->
                <div class="relative group">
                    <label class="flex justify-between text-sm font-semibold text-gray-700 mb-1">
                        <span>Descripción del Reporte</span>
                        <span id="plantilla-helper" class="text-xs text-gray-500">Seleccione una categoría para cargar la plantilla</span>
                    </label>
                    <textarea id="plantilla" rows="8" class="block w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-200 focus:border-oxxo-red font-mono text-sm shadow-sm transition-colors"
                              placeholder="Seleccione una categoría para cargar la plantilla..." disabled></textarea>
                </div>

                <!-- Fila 4: Mensajes y Botón de Envío -->
                <div class="pt-4 border-t border-gray-100">
                    <div id="mensaje-sistema" class="hidden mb-4 p-4 rounded-lg text-sm font-medium flex items-center gap-3 success-message">
                        <!-- Mensajes de estado -->
                    </div>
                    <div class="flex justify-end">
                        <button id="btn-enviar" onclick="enviarReporteAlServidor()" class="btn-primary text-white font-bold py-3 px-10 rounded-lg shadow-xl flex items-center gap-2 transition-all w-full md:w-auto justify-center">
                            <span id="btn-icon"><i data-lucide="send" class="w-5 h-5"></i></span>
                            <span id="btn-text">Enviar Reporte</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Script de JavaScript (Lógica del Frontend) -->
    <script>
        lucide.createIcons();
        const fecha = new Date().toLocaleDateString('es-MX', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        // const fecha no se usa aquí pero sí en el servidor

        // Objeto con las plantillas
        const plantillas = {
            'Fallo de Equipo': '[REPORTE DE EQUIPO]\n----------------------------------\n- EQUIPO AFECTADO: [Ej: PDV 1, Handheld, Impresora]\n- FALLA DETECTADA: [Ej: No enciende, Lento, Atascado]\n- IMPACTO EN TIENDA: [Ej: Tienda detenida, No se puede cobrar]\n- CÓDIGO DE ERROR: [Si aplica]\n\nOBSERVACIONES:',
            'Mantenimiento': '[SOLICITUD DE MANTENIMIENTO]\n----------------------------------\n- ACTIVO: [Ej: Refrigerador 2, Aire Acondicionado, Puerta Principal]\n- TIPO DE FALLA: [Ej: No enfría, Ruidos extraños, No cierra]\n- UBICACIÓN: [Ej: Área de lácteos, Bodega]\n\nOBSERVACIONES:',
            'Fallo de Enlaces': '[REPORTE DE ENLACES Y RED]\n----------------------------------\n- SERVICIO AFECTADO: [Ej: Santander, Banamex, Red Interna, Internet]\n- FALLA: [Ej: Caído, Intermitente, Latencia alta]\n- IMPACTO: [Ej: No hay depósitos, No hay recargas]\n\nOBSERVACIONES:',
            'Daño a Tienda': '[REPORTE DE DAÑOS]\n----------------------------------\n- ÁREA AFECTADA: [Ej: Fachada, Baños, Piso de venta]\n- TIPO DE DAÑO: [Ej: Vidrio roto, Fuga de agua, Grafiti]\n- ¿AFECTA OPERACIÓN?: [Sí/No]\n\nOBSERVACIONES:',
            'Otro': '[REPORTE GENERAL]\n----------------------------------\n- ASUNTO: [Describa brevemente]\n- DETALLE: [Explique la situación]\n\nOBSERVACIONES:',
            '': 'Seleccione una categoría para cargar la plantilla...'
        };

        // NUEVA FUNCIÓN: Actualiza la plantilla cuando cambia la categoría
        function actualizarPlantilla() {
            const categoria = document.getElementById('categoria').value;
            const plantillaText = document.getElementById('plantilla');
            const plantillaHelper = document.getElementById('plantilla-helper');

            plantillaText.value = plantillas[categoria] || plantillas[''];

            if (categoria === "") {
                plantillaText.disabled = true;
                plantillaHelper.textContent = "Seleccione una categoría para cargar la plantilla";
            } else {
                plantillaText.disabled = false;
                plantillaHelper.textContent = `Plantilla para "${categoria}" cargada.`;
            }
        }
        
        // Limpia el formulario
        function limpiarFormulario() {
            document.getElementById('tienda').value = '';
            document.getElementById('categoria').value = '';
            document.getElementById('prioridad').value = 'Normal';
            actualizarPlantilla(); // Esto limpiará y deshabilitará el textarea
        }

        // Función para actualizar el icono de último estado en la Navbar
        function updateLastStatus(tipo) {
            // (Código idéntico al anterior, no necesita cambios)
            const statusElement = document.getElementById('last-status');
            statusElement.classList.remove('text-gray-500', 'text-green-600', 'text-red-600');
            let icon, text, color;
            if (tipo === 'success') { icon = 'check-circle'; text = 'Último Envío: Éxito'; color = 'text-green-600'; }
            else if (tipo === 'error') { icon = 'x-circle'; text = 'Último Envío: Falló'; color = 'text-red-600'; }
            else { icon = 'minus-circle'; text = 'Sin Envíos'; color = 'text-gray-500'; }
            statusElement.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5 ${color}"></i><span class="hidden sm:inline">${text}</span>`;
            statusElement.classList.add(color);
            lucide.createIcons();
        }

        // FUNCIÓN CLAVE: SE CONECTA CON EL SERVIDOR PYTHON (Flask)
        async function enviarReporteAlServidor() {
            // 1. Obtener TODOS los datos del formulario
            const tienda = document.getElementById('tienda').value.trim();
            const proveedor = document.getElementById('proveedor_email').value.trim();
            const plantilla = document.getElementById('plantilla').value.trim();
            // --- NUEVOS CAMPOS ---
            const categoria = document.getElementById('categoria').value;
            const prioridad = document.getElementById('prioridad').value;
            
            const btn = document.getElementById('btn-enviar');
            const btnText = document.getElementById('btn-text');
            const btnIcon = document.getElementById('btn-icon');

            // 2. Validación (Ahora incluye categoría)
            if (!tienda || !proveedor || !plantilla || !categoria) {
                mostrarMensaje('Por favor complete todos los campos (Tienda, Correo, Categoría y Reporte).', 'error');
                updateLastStatus('error');
                return;
            }

            // 3. Modo "Cargando"
            mostrarMensaje('Cargando...', 'loading');
            btn.disabled = true;
            btnText.textContent = "Procesando envío...";
            btnIcon.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 spinner"></i>';
            lucide.createIcons();

            // 4. Preparar datos para enviar a Python (Incluye nuevos campos)
            const datosDelReporte = {
                tienda: tienda,
                proveedor: proveedor,
                mensaje: plantilla, // El textarea ya tiene la plantilla
                categoria: categoria,
                prioridad: prioridad
            };

            // 5. Conexión con el servidor Python
            try {
                const SERVER_URL_BASE = 'https://oxxo-reporte-automatico.onrender.com';/enviar-reporte', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datosDelReporte)
                });

                const resultado = await respuesta.json();

                if (respuesta.ok) {
                    mostrarMensaje('✅ ¡Reporte enviado exitosamente! Revisa el status en tu correo.', 'success');
                    updateLastStatus('success');
                    limpiarFormulario(); // Limpia todo el formulario
                } else {
                    mostrarMensaje(`❌ Error del servidor: ${resultado.error}. Revisa la configuración en server.py.`, 'error');
                    updateLastStatus('error');
                }

            } catch (error) {
                console.error("Error de conexión:", error);
                mostrarMensaje('⚠️ No se pudo conectar con el servidor. ¿Ejecutaste "python server.py" en la terminal?', 'error');
                updateLastStatus('error');
            } finally {
                // 6. Restaurar botón
                btn.disabled = false;
                btnText.textContent = "Enviar Reporte";
                btnIcon.innerHTML = '<i data-lucide="send" class="w-5 h-5"></i>';
                lucide.createIcons();
            }
        }

        // Función para mostrar mensajes
        function mostrarMensaje(texto, tipo) {
            // (Código idéntico al anterior, no necesita cambios)
            const msgBox = document.getElementById('mensaje-sistema');
            msgBox.classList.remove('hidden', 'bg-red-50', 'text-red-800', 'bg-green-50', 'text-green-800', 'border', 'border-red-200', 'border-green-200', 'success-message');
            msgBox.innerHTML = texto;
            if (tipo === 'error') { msgBox.classList.add('bg-red-50', 'text-red-800', 'border', 'border-red-200'); }
            else if (tipo === 'success') { msgBox.classList.add('bg-green-50', 'text-green-800', 'border', 'border-green-200', 'success-message'); }
            else { msgBox.classList.add('bg-gray-100', 'text-gray-600'); }
            msgBox.classList.remove('hidden');
        }

        // Inicializar el estado al cargar la página
        window.onload = () => {
             updateLastStatus('initial');
             actualizarPlantilla(); // Llama a esto para asegurar que el textarea esté deshabilitado al inicio
        };
    </script>
</body>

</html>
